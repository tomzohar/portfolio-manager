{
  "featureName": "Stock Screener Tool",
  "description": "Proactively searches the market for investment opportunities based on user-defined criteria combining technical indicators and fundamental metrics. Transforms the agent from reactive (analyzing tickers user provides) to proactive (discovering and suggesting tickers that meet specific investment criteria).",
  
  "feasibility": {
    "status": "PARTIALLY SUPPORTED - REQUIRES CUSTOM IMPLEMENTATION",
    "apiSupport": "Polygon.io does NOT provide a dedicated stock screener endpoint with multi-criteria filtering",
    "implementationApproach": "Multi-step process using existing endpoints with client-side filtering",
    "requiredEndpoints": [
      "GET /v3/reference/tickers - Fetch universe of tickers with basic filters (market, exchange, type)",
      "GET /v2/snapshot/locale/us/markets/stocks/tickers - Current market snapshot for all stocks",
      "GET /vX/reference/financials/ratios - Fundamental ratios for individual tickers (requires multiple calls)",
      "Technical analysis can be performed using existing technical_analyst tool logic on fetched data"
    ],
    "limitations": [
      "No single API call for complex multi-criteria screening",
      "Requires fetching data for multiple tickers and filtering client-side (performance impact)",
      "API rate limits may restrict scanning large universes (e.g., all US stocks)",
      "Fundamental data requires individual ticker API calls (expensive for screening hundreds of stocks)"
    ],
    "proposedSolution": "Implement a hybrid approach: (1) Use reference tickers endpoint to get stock universe with basic filters, (2) Use snapshot endpoint to get current prices/volume for quick technical filters, (3) For smaller result sets, fetch fundamental data for final filtering"
  },

  "userStories": [
    "User asks 'Find me tech stocks with RSI below 30 (oversold) and P/E under 20' and receives a curated list of 5-10 undervalued oversold tech stocks",
    "User requests 'Show me high dividend stocks with low volatility' and agent screens for stocks with dividend yield > 3% and low ATR",
    "User wants 'Growth stocks in healthcare that are trending up' and receives stocks with revenue growth > 20% YoY and price above SMA 200",
    "User asks 'What stocks are breaking out today?' and agent finds stocks with price crossing above resistance levels with high volume"
  ],

  "userFlow": [
    "User logs in and navigates to chat",
    "User asks for stock screening query (e.g., 'Find oversold tech stocks with strong fundamentals')",
    "Agent orchestrator determines stock_screener tool is needed",
    "Agent calls stock_screener with parsed criteria (sector, technical filters, fundamental filters)",
    "Tool Phase 1: Fetches stock universe filtered by sector/market cap if specified",
    "Tool Phase 2: Applies quick technical filters using snapshot data (price, volume, basic ratios)",
    "Tool Phase 3: For remaining candidates (<50 stocks), fetches fundamental data for detailed filtering",
    "Tool returns filtered list of 5-20 matching stocks ranked by how well they meet criteria",
    "Agent presents results with brief analysis of each stock and reasoning for inclusion",
    "User can ask follow-up: 'Analyze the top 3 in detail' triggering deeper fundamental/technical analysis"
  ],

  "edgeCases": [
    "User criteria too restrictive - no stocks match (e.g., 'P/E < 5 and revenue growth > 50%')",
    "User criteria too broad - thousands of matches (need to rank and limit results)",
    "Some stocks missing fundamental data - should they be excluded or flagged?",
    "API rate limit hit during screening process (need to handle gracefully)",
    "User specifies conflicting criteria (e.g., 'high dividend AND high growth' - rare combination)",
    "Screening takes too long (>30 seconds) - may need to abort and suggest narrower criteria",
    "Market hours vs after hours - some data may be stale",
    "User asks for criteria not supported by available data (e.g., 'insider buying' - not available)"
  ],

  "toolSchema": {
    "name": "stock_screener",
    "description": "Searches the market for stocks matching user-defined criteria. Supports filtering by sector, technical indicators (RSI, MACD, price vs moving averages, volume), fundamental metrics (P/E, revenue growth, profit margins), and market cap. Returns ranked list of matching stocks with reasoning. WARNING: Complex screens may take 20-30 seconds due to API limitations.",
    "parameters": {
      "criteria": {
        "type": "object",
        "description": "Screening criteria",
        "properties": {
          "sector": {
            "type": "string",
            "description": "Industry sector (e.g., 'Technology', 'Healthcare', 'Finance')",
            "optional": true
          },
          "market_cap_min": {
            "type": "number",
            "description": "Minimum market cap in millions USD",
            "optional": true
          },
          "market_cap_max": {
            "type": "number",
            "description": "Maximum market cap in millions USD",
            "optional": true
          },
          "technical": {
            "type": "object",
            "description": "Technical indicator filters",
            "properties": {
              "rsi_min": { "type": "number", "min": 0, "max": 100 },
              "rsi_max": { "type": "number", "min": 0, "max": 100 },
              "price_vs_sma200": { "type": "string", "enum": ["above", "below", "any"] },
              "volume_avg_min": { "type": "number", "description": "Minimum average daily volume" }
            },
            "optional": true
          },
          "fundamental": {
            "type": "object",
            "description": "Fundamental metric filters",
            "properties": {
              "pe_min": { "type": "number" },
              "pe_max": { "type": "number" },
              "revenue_growth_min_yoy": { "type": "number", "description": "Min YoY revenue growth %" },
              "profit_margin_min": { "type": "number", "description": "Min net profit margin %" },
              "debt_to_equity_max": { "type": "number" }
            },
            "optional": true
          }
        }
      },
      "limit": {
        "type": "number",
        "description": "Maximum number of results to return (default: 10, max: 25)",
        "default": 10,
        "min": 1,
        "max": 25
      },
      "sort_by": {
        "type": "string",
        "description": "How to rank results",
        "enum": ["market_cap", "volume", "match_score", "revenue_growth"],
        "default": "match_score"
      }
    }
  },

  "outputStructure": {
    "matches_found": "number",
    "matches_returned": "number",
    "execution_time_seconds": "number",
    "screening_criteria": "object (echo back the criteria used)",
    "results": [
      {
        "ticker": "string",
        "company_name": "string",
        "current_price": "number",
        "market_cap": "number",
        "match_score": "number (0.0-1.0, how well it matches criteria)",
        "matching_criteria": "string[] (which criteria it met, e.g., ['RSI < 30', 'P/E < 20'])",
        "technical_snapshot": {
          "rsi": "number | null",
          "price_vs_sma200": "above | below | null",
          "volume_avg": "number | null"
        },
        "fundamental_snapshot": {
          "pe_ratio": "number | null",
          "revenue_growth_yoy": "number | null",
          "profit_margin": "number | null"
        }
      }
    ],
    "warning": "string | undefined (e.g., 'Some stocks excluded due to missing fundamental data')",
    "error": "string | undefined"
  },

  "state": {
    "description": "Tool is stateless. Each screening runs fresh against current market data.",
    "caching": "Reference ticker list could be cached for 24 hours. Market snapshot should NOT be cached (real-time needed).",
    "performance": "Consider implementing caching layer for common screens to improve response time"
  },

  "confidence": {
    "highConfidence": "Found 5-25 matches with complete data for all specified criteria",
    "mediumConfidence": "Found matches but some stocks missing partial fundamental data, or only 1-4 matches found",
    "lowConfidence": "Zero matches found OR criteria too broad (>100 matches, had to truncate significantly)",
    "refuseToAnswer": "Criteria includes unsupported metrics (e.g., 'insider buying', 'short interest'), or screening process failed due to API errors. Agent should explain limitations and suggest alternative criteria."
  },

  "guardrails": {
    "validationRules": [
      "At least one filtering criterion must be provided (can't screen entire market without filters)",
      "If technical filters specified, universe must be limited by sector or market cap to avoid timeout",
      "Max 25 results to prevent overwhelming user and API quota",
      "Execution timeout: 45 seconds max, abort and return partial results with warning"
    ],
    "performanceProtection": [
      "If user criteria would require screening >500 stocks, prompt to narrow criteria",
      "Implement progressive filtering: apply cheapest filters first (sector, market cap), then expensive ones (fundamentals)",
      "Use snapshot endpoint to batch-fetch current prices rather than individual ticker calls"
    ],
    "errorHandling": [
      "No matches: Suggest relaxing one criterion at a time",
      "Too many matches: Suggest adding more restrictive criterion",
      "API timeout: Return partial results with warning about incomplete screening",
      "Rate limit: Pause and retry with exponential backoff, or return cached results if available"
    ]
  },

  "citations": {
    "source": "Polygon.io (multiple endpoints)",
    "structure": {
      "source_type": "SCREENING_RESULTS",
      "screening_timestamp": "ISO date when screen was run",
      "data_sources": ["Polygon.io Reference Tickers", "Polygon.io Market Snapshot", "Polygon.io Financials"],
      "note": "Results represent market conditions at time of screening and may change rapidly"
    },
    "citationDisplay": "Single citation for overall screening process. Individual stocks in results can be analyzed separately for detailed citations."
  },

  "integrationPoints": {
    "requiredServices": [
      "PolygonApiService - Use existing getTickers(), getSnapshot() methods; extend with batch capabilities",
      "Reuse calculateTechnicalIndicators() logic from technical-analyst.tool.ts",
      "CitationService - Track screening citations"
    ],
    "newServiceNeeded": "Consider creating ScreeningService to encapsulate multi-step screening logic and caching",
    "toolRegistration": "Register in agents.module.ts as stock_screener"
  },

  "testingStrategy": {
    "unitTests": [
      "Test criteria parsing and validation",
      "Test progressive filtering logic with mock data",
      "Test ranking/scoring algorithm",
      "Test handling of null/missing data in filtering"
    ],
    "integrationTests": [
      "Test screening with single technical criterion (RSI < 30) using real Polygon data",
      "Test screening with combined tech + fundamental criteria",
      "Test performance with large stock universe (>100 tickers)",
      "Verify results are properly ranked"
    ],
    "e2eTests": [
      "User asks 'Find oversold tech stocks' and receives valid results",
      "User asks for impossible criteria (no matches) and gets helpful error",
      "User asks to analyze top result from screener (verify tool chaining works)",
      "Verify screening completes within 45 second timeout"
    ]
  },

  "priority": "MEDIUM",
  "estimatedEffort": "5-7 days (complex due to multi-step processing and performance optimization needs)",
  "dependencies": [
    "Polygon API subscription with sufficient rate limits for screening use case",
    "May need to upgrade API tier if current rate limits too restrictive",
    "Requires backend optimization for efficient parallel API calls",
    "Consider building internal ticker metadata cache to reduce API dependency"
  ],

  "futureEnhancements": [
    "Save custom screens for reuse (e.g., 'My Value Stock Screen')",
    "Schedule screens to run daily and notify user of new matches",
    "Add more advanced filters: short interest, analyst consensus, price momentum",
    "Industry-relative screening (e.g., P/E below industry average)",
    "Backtesting: 'Show me stocks that matched these criteria 6 months ago and their performance since'"
  ],

  "alternativeApproach": {
    "description": "Use third-party stock screener API instead of building custom solution",
    "options": [
      "FinViz API - Free tier available, has built-in screener",
      "Finnhub API - Stock screener endpoint available",
      "Alpha Vantage - Fundamental data search capabilities"
    ],
    "tradeoffs": "Third-party APIs may be easier to implement but add another dependency and potential point of failure. Polygon-only solution keeps tech stack simpler but requires more development effort."
  }
}
