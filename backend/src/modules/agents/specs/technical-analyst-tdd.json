{
  "project": "Technical Analyst Agent Upgrade",
  "version": "1.0.0",
  "status": "DRAFT",
  "definitions": {
    "intervals": {
      "15m": { "multiplier": 15, "timespan": "minute" },
      "1h": { "multiplier": 1, "timespan": "hour" },
      "1d": { "multiplier": 1, "timespan": "day" },
      "1wk": { "multiplier": 1, "timespan": "week" }
    },
    "libraries": {
      "technicalindicators": "^3.1.0"
    }
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "Intraday Technical Analysis",
      "asA": "Day Trader",
      "iWantTo": "request technical analysis on shorter timeframes (15m, 1h)",
      "soThat": "I can identify intraday entry points",
      "technicalTasks": [
        {
          "id": "TASK-001-01",
          "component": "AssetsModule",
          "file": "backend/src/modules/assets/services/polygon-api.service.ts",
          "title": "Refactor getAggregates for Timeframe Support",
          "description": "Refactor `getAggregates` method to accept nullable `multiplier` (number) and `timespan` (string) arguments. Ensure backward compatibility with existing calls (default to 1, 'day').",
          "acceptanceCriteria": [
            "Method signature updated to `getAggregates(ticker, from, to, timespan?, multiplier?)`",
            "URL construction correctly uses multiplier and timespan",
            "Existing unit tests pass without modification",
            "New unit test verifies correct URL for 15m and 1h inputs"
          ],
          "complexity": "Low",
          "estimatedTime": "1h",
          "status": "DONE"
        },
        {
          "id": "TASK-001-02",
          "component": "AgentsModule",
          "file": "backend/src/modules/agents/tools/technical-analyst.tool.ts",
          "title": "Update Tool Schema for Intervals",
          "description": "Update `TechnicalAnalystTool` Zod schema to include an optional `interval` field with enum values ['15m', '1h', '1d', '1wk']. Default to '1d'.",
          "acceptanceCriteria": [
            "Schema accepts '15m', '1h', '1d', '1wk'",
            "Schema rejects invalid intervals",
            "Default value remains '1d' (implied or explicit)"
          ],
          "complexity": "Low",
          "estimatedTime": "30m",
          "status": "DONE"
        },
        {
          "id": "TASK-001-03",
          "component": "AgentsModule",
          "file": "backend/src/modules/agents/tools/technical-analyst.tool.ts",
          "title": "Implement Timeframe Mapping Logic",
          "description": "Map the input `interval` enum to the corresponding `multiplier` and `timespan` values before calling `polygonService.getAggregates`.",
          "acceptanceCriteria": [
            "'15m' maps to 15, 'minute'",
            "'1h' maps to 1, 'hour'",
            "'1d' maps to 1, 'day'",
            "'1wk' maps to 1, 'week'",
            "Tool executes successfully with different intervals"
          ],
          "complexity": "Low",
          "estimatedTime": "30m",
          "status": "DONE"
        }
      ]
    },
    {
      "id": "US-002",
      "title": "Volume Analysis (VWAP & OBV)",
      "asA": "Swing Trader",
      "iWantTo": "know if a price breakout is supported by volume (VWAP, OBV)",
      "soThat": "I can avoid fake-outs",
      "technicalTasks": [
        {
          "id": "TASK-002-01",
          "component": "AgentsModule",
          "file": "backend/src/modules/agents/tools/technical-analyst.tool.ts",
          "title": "Integrate VWAP and OBV Indicators",
          "description": "Import `VWAP` and `OBV` from `technicalindicators`. Implement calculation logic in `calculateTechnicalIndicators` function.",
          "acceptanceCriteria": [
            "VWAP calculated correctly using High, Low, Close, Volume",
            "OBV calculated correctly using Close, Volume",
            "Edge cases (zero volume) handled gracefully"
          ],
          "complexity": "Medium",
          "estimatedTime": "1h",
          "status": "DONE"
        },
        {
          "id": "TASK-002-02",
          "component": "AgentsModule",
          "file": "backend/src/modules/agents/tools/technical-analyst.tool.ts",
          "title": "Expose Volume Metrics in Result",
          "description": "Update `TechnicalIndicators` interface to include `VWAP` and `OBV`. Add these values to the return object.",
          "acceptanceCriteria": [
            "Interface includes `VWAP: number` and `OBV: number`",
            "Tool output JSON contains these new fields"
          ],
          "complexity": "Low",
          "estimatedTime": "30m",
          "status": "DONE"
        }
      ]
    },
    {
      "id": "US-003",
      "title": "Support & Resistance Levels",
      "asA": "Portfolio Manager",
      "iWantTo": "see automated Support & Resistance levels",
      "soThat": "I can objectively set stop-loss and take-profit orders",
      "technicalTasks": [
        {
          "id": "TASK-003-01",
          "component": "AgentsModule",
          "file": "backend/src/modules/agents/tools/technical-analyst.tool.ts",
          "title": "Implement Pivot Point Calculation",
          "description": "Calculate Standard Pivot Points using the previous period's High, Low, and Close. Formulas: P=(H+L+C)/3, R1=2*P-L, S1=2*P-H, etc.",
          "acceptanceCriteria": [
            "Calculates Pivot (P), R1, R2, S1, S2",
            "Uses the LATEST complete bar for calculation if strictly intraday, or previous Day's candle for Daily analysis (clarify if using standard Daily Pivots for intraday)",
            "For this iteration: Use the last complete bar's data for calculation"
          ],
          "complexity": "Medium",
          "estimatedTime": "1h",
          "status": "DONE"
        },
        {
          "id": "TASK-003-02",
          "component": "AgentsModule",
          "file": "backend/src/modules/agents/tools/technical-analyst.tool.ts",
          "title": "Add Support/Resistance to Output",
          "description": "Add a new `support_resistance` object to `TechnicalAnalysisResult` containing `{ pivot, r1, r2, s1, s2 }`.",
          "acceptanceCriteria": [
            "Result schema updated",
            "Values are correctly populated in response"
          ],
          "complexity": "Low",
          "estimatedTime": "30m",
          "status": "DONE"
        }
      ]
    },
    {
      "id": "US-004",
      "title": "Automated Pattern Recognition",
      "asA": "Technical Analyst",
      "iWantTo": "automatically detect candlestick patterns (Hammer, Doji)",
      "soThat": "I can spot potential trend reversals",
      "technicalTasks": [
        {
          "id": "TASK-004-01",
          "component": "AgentsModule",
          "file": "backend/src/modules/agents/tools/technical-analyst.tool.ts",
          "title": "Integrate Candlestick Pattern Detection",
          "description": "Use `technicalindicators` pattern detection (specifically `bullish` and `bearish` combined, or specific patterns like `Hammer`, `Doji`, `Engulfing`).",
          "acceptanceCriteria": [
            "Detects at least: Doji, Hammer, Bullish/Bearish Engulfing",
            "Runs detection on the last 5 candles to find recent patterns",
            "Returns a list of detected patterns with their signal (Bullish/Bearish)"
          ],
          "complexity": "Medium",
          "estimatedTime": "1.5h",
          "status": "DONE"
        },
        {
          "id": "TASK-004-02",
          "component": "AgentsModule",
          "file": "backend/src/modules/agents/tools/technical-analyst.tool.ts",
          "title": "Update Output with Patterns",
          "description": "Add `candlestick_patterns` array to `TechnicalAnalysisResult`. Each item should be `{ name: string, signal: 'bullish' | 'bearish' | 'neutral' }`.",
          "acceptanceCriteria": [
            "Result includes detected patterns",
            "Empty array if no patterns found"
          ],
          "complexity": "Low",
          "estimatedTime": "30m",
          "status": "DONE"
        }
      ]
    },
    {
      "id": "US-005",
      "title": "Comparative Relative Strength",
      "asA": "Sector Analyst",
      "iWantTo": "compare a stock's relative strength against the market (SPY)",
      "soThat": "I can identify leaders vs laggards",
      "technicalTasks": [
        {
          "id": "TASK-005-01",
          "component": "AgentsModule",
          "file": "backend/src/modules/agents/tools/technical-analyst.tool.ts",
          "title": "Fetch Benchmark (SPY) Data",
          "description": "In `func`, trigger a parallel fetch for 'SPY' data for the same period/interval. Handle 429/Rate Limits if necessary.",
          "acceptanceCriteria": [
            "Fetches target ticker and SPY concurrently",
            "Handles error if SPY fetch fails (should not fail entire analysis, just omit RS)",
            "Aligns SPY data with target ticker data by date/time"
          ],
          "complexity": "High",
          "estimatedTime": "2h",
          "status": "DONE"
        },
        {
          "id": "TASK-005-02",
          "component": "AgentsModule",
          "file": "backend/src/modules/agents/tools/technical-analyst.tool.ts",
          "title": "Calculate Relative Strength Ratio",
          "description": "Calculate `RS = Stock_Close / SPY_Close` for each bar. Compute a simple metric like `RS_Change_Percent` over the period.",
          "acceptanceCriteria": [
            "Calculates RS series",
            "Computes performance comparison (e.g., Stock +5% vs SPY +2% = RS Outperformance)",
            "Adds `relative_strength` object to result: `{ vs_market: 'outperform' | 'underperform', correlation: number }`"
          ],
          "complexity": "Medium",
          "estimatedTime": "1.5h",
          "status": "DONE"
        }
      ]
    }
  ],
  "edgeCases": [
    {
      "scenario": "Low Liquidity / Missing Bars",
      "handling": "Align arrays by timestamp. If exact match missing, use previous close (forward fill) or omit calculation point."
    },
    {
      "scenario": "Insufficient Data for Timeframe",
      "handling": "Return specific error `INSUFFICIENT_DATA_FOR_INTERVAL`. Tool should suggest falling back to higher timeframe."
    },
    {
      "scenario": "API Rate Limits",
      "handling": "Implement retry logic with exponential backoff in `PolygonApiService`. If SPY fetch fails, return analysis without RS data."
    }
  ]
}
