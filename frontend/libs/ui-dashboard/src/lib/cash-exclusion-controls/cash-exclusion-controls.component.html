<div class="cash-exclusion-controls">
  <!-- Controls Row: Cash Exclusion Toggle + Timeframe Selector -->
  <div class="controls-row">
    <div class="toggle-container">
      <div class="toggle-container-content">
        <mat-slide-toggle
          data-testid="exclude-cash-toggle"
          [checked]="excludeCash()"
          [disabled]="toggleDisabled()"
          (change)="onExcludeCashToggle($event.checked)"
          aria-label="Exclude idle cash from performance calculations"
        >
        </mat-slide-toggle>
        @if (analysis() && viewModeText()) {
          <span class="view-mode-badge" data-testid="view-mode-badge">
            {{ viewModeText() }}
          </span>
        }
        <button
          mat-icon-button
          data-testid="cash-exclusion-tooltip"
          matTooltip="When enabled, performance calculations exclude idle cash positions and show only the return of your invested capital. This helps you see the true performance of your stock picks without cash drag."
          matTooltipPosition="below"
          aria-label="Information about cash exclusion"
          class="info-icon"
        >
          <mat-icon>info</mat-icon>
        </button>
      </div>
      @if (excludeCash() && cashAllocationPercent() !== null && !isFullyCash()) {
        <span class="cash-allocation-text" data-testid="cash-allocation-info">
          ({{ cashAllocationPercent() }} avg cash)
        </span>
      }
      @if (toggleDisabled() && !isFullyCash()) {
        <span class="toggle-disabled-hint" data-testid="toggle-disabled-hint">
          @if (loading()) {
            Loading...
          } @else if (error()) {
            Error loading data
          } @else {
            No data available
          }
        </span>
      }
    </div>

    <lib-timeframe-selector
      [selectedTimeframe]="selectedTimeframe()"
      (timeframeChanged)="onTimeframeChange($event)"
    />
  </div>

  <!-- Live region for accessibility -->
  <div aria-live="polite" class="sr-only">
    @if (analysis()) {
      {{ viewModeText() }} view active
    }
  </div>
</div>
