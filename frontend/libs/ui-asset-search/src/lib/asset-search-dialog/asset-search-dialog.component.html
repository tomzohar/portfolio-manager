<h2 mat-dialog-title>{{ title() }}</h2>

<mat-dialog-content class="fixed-content">
  <!-- Search Input with Autocomplete -->
  <mat-form-field appearance="fill" class="search-field">
    <mat-label>{{ placeholder() }}</mat-label>
    <input
      matInput
      type="text"
      [value]="searchQuery()"
      (input)="onInputChange($any($event.target).value)"
      [matAutocomplete]="auto"
      autocomplete="off"
      cdkFocusInitial
      />
    <mat-icon matSuffix>search</mat-icon>
    <!-- Loading indicator in input suffix -->
    @if (loading()) {
      <mat-spinner matSuffix diameter="20"></mat-spinner>
    }
  </mat-form-field>

  <!-- Autocomplete Panel (Floating) -->
  <mat-autocomplete
    #auto="matAutocomplete"
    [displayWith]="displayFn"
    [autoActiveFirstOption]="true"
    (optionSelected)="onAutocompleteSelect($event)"
    panelClass="asset-autocomplete"
  >
    <!-- Error State in Panel -->
    @if (error(); as errorMessage) {
      <mat-option disabled class="state-option error-state">
        <mat-icon color="warn">error</mat-icon>
        <span>{{ errorMessage }}</span>
      </mat-option>
    }

    <!-- No Results State -->
    @if (noResults()) {
      <mat-option disabled class="state-option no-results-state">
        <mat-icon>search_off</mat-icon>
        <span>No results found for "{{ searchQuery() }}"</span>
      </mat-option>
    }

    <!-- Results Options -->
    @if (!loading() && !error() && results().length > 0) {
      @for (result of results(); track result.ticker) {
        <mat-option
          [value]="result"
          [disabled]="!isSingleMode() && !canSelect() && !isSelected(result)"
          [class.selected-option]="!isSingleMode() && isSelected(result)"
          (click)="onOptionClick($event, result)"
        >
          <div class="ticker-option">
            @if (!isSingleMode()) {
              <mat-checkbox
                [checked]="isSelected(result)"
                class="option-checkbox"
              />
            }
            <div class="ticker-item">
              <span class="ticker-symbol">{{ result.ticker }}</span>
              <span class="ticker-name">{{ result.name }}</span>
            </div>
          </div>
        </mat-option>
      }
    }
  </mat-autocomplete>

  <!-- Selected Items Preview (Multi-select mode only) -->
  @if (!isSingleMode() && selectedCount() > 0) {
    <div class="selected-preview">
      <span class="selected-label">Selected ({{ selectedCount() }}):</span>
      <mat-chip-set>
        @for (item of selectedItems(); track item.ticker) {
          <mat-chip (removed)="removeSelection(item)">
            {{ item.ticker }}
            <button matChipRemove aria-label="Remove {{ item.ticker }}">
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip>
        }
      </mat-chip-set>
    </div>
  }

</mat-dialog-content>

<mat-dialog-actions align="end">
  <lib-button [config]="{ label: 'Cancel', variant: 'flat' }" (clicked)="onCancel()" />
  @if (!isSingleMode()) {
    <lib-button
      [config]="{
        label: 'Done' + (selectedCount() > 0 ? ' (' + selectedCount() + ')' : ''),
        variant: 'raised',
        color: 'primary',
        disabled: selectedCount() === 0
      }"
      (clicked)="onDone()"
    />
  }
</mat-dialog-actions>

